---
- name: "Verify \u2014 device_switch_routes (replaced)"
  hosts: localhost
  gather_facts: false
  vars_files:
  - vars.yml
  tasks:
  - name: Gather current configuration
    cisco.meraki_rm.meraki_device_switch_routes:
      serial: Q2XX-XXXX-XXXX
      state: gathered
    register: gathered
  - name: Assert configuration exists after replaced
    ansible.builtin.assert:
      that:
      - gathered.gathered is defined
      - gathered.gathered | length > 0
      fail_msg: Expected at least one resource after replaced
  - name: Compare expected paths to gathered state (subset check)
    ansible.builtin.set_fact:
      path_check: '{{ expected_paths | cisco.meraki_rm.path_contained_in(result_paths) }}'
    vars:
      _exclude_pk: "{{ server_assigned_pk | default('') }}"
      _verify_config: >-
        {{ expected_config | dict2items
           | rejectattr('key', 'equalto', _exclude_pk)
           | items2dict }}
      expected_paths: '{{ _verify_config | ansible.utils.to_paths }}'
      result_paths: '{{ gathered.gathered[0] | ansible.utils.to_paths }}'
  - name: Assert all expected fields are present and match
    ansible.builtin.assert:
      that: path_check.contained | bool
      success_msg: '{{ success_msg }}'
      fail_msg: '{{ fail_msg }}'
    vars:
      success_msg: 'All expected fields match. Extras: {{ path_check.extras }}'
      fail_msg: 'Missing or mismatch: {{ path_check.missing }}. Extras: {{ path_check.extras }}'
