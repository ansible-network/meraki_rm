---
# Stop the mock server and platform manager after all scenarios complete.
- name: Destroy â€” Stop Meraki mock server and platform manager
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Find mock server process
      ansible.builtin.shell:
        cmd: pgrep -f "tools.mock_server.server" || true
      register: mock_pids
      changed_when: false

    - name: Stop mock server
      ansible.builtin.command:
        cmd: "kill {{ item }}"
      loop: "{{ mock_pids.stdout_lines }}"
      when: mock_pids.stdout_lines | length > 0
      changed_when: true
      ignore_errors: true

    - name: Determine runtime directory
      ansible.builtin.set_fact:
        _mgr_runtime: >-
          {{ lookup('env', 'XDG_RUNTIME_DIR')
             | default('/tmp/meraki_rm_' + lookup('pipe', 'id -u'), true) }}/meraki_rm

    - name: Remove .survive flag (watchdog will shut manager down)
      ansible.builtin.file:
        path: "{{ _mgr_runtime }}/manager_localhost.survive"
        state: absent

    - name: Wait for manager to exit
      ansible.builtin.wait_for:
        path: "{{ _mgr_runtime }}/manager_localhost.sock"
        state: absent
        timeout: 10
      ignore_errors: true

    - name: Clean up remaining runtime files
      ansible.builtin.file:
        path: "{{ _mgr_runtime }}/{{ item }}"
        state: absent
      loop:
        - manager_localhost.sock
        - manager_localhost.key
        - manager_localhost.pid

    - name: Wait for mock server port to close
      ansible.builtin.wait_for:
        port: "{{ mock_server_port }}"
        state: stopped
        timeout: 10
      ignore_errors: true
