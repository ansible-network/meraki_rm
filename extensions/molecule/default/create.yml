---
# Start the stateful mock server for integration testing.
- name: Create â€” Start Meraki mock server
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Kill any stale mock server on target port
      ansible.builtin.shell: |
        fuser {{ mock_server_port }}/tcp -k 2>/dev/null || true
      changed_when: false

    - name: Start mock server in background
      ansible.builtin.command:
        cmd: >-
          python -m tools.mock_server.server
          --spec {{ mock_server_spec }}
          --port {{ mock_server_port }}
          --daemon
      args:
        chdir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}"
      changed_when: true
      register: server_start

    - name: Wait for mock server to be ready
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ mock_server_port }}/health"
        method: GET
        status_code: 200
      register: health_check
      retries: 30
      delay: 3
      until: health_check.status == 200

    - name: Store mock server PID
      ansible.builtin.set_fact:
        mock_server_pid: "{{ server_start.stdout | trim }}"
        cacheable: true

    - name: Determine runtime directory
      ansible.builtin.set_fact:
        _mgr_runtime: >-
          {{ lookup('env', 'XDG_RUNTIME_DIR')
             | default('/tmp/meraki_rm_' + lookup('pipe', 'id -u'), true) }}/meraki_rm

    - name: Ensure runtime directory exists
      ansible.builtin.file:
        path: "{{ _mgr_runtime }}"
        state: directory
        mode: "0700"

    - name: Create .survive flag for platform manager
      ansible.builtin.file:
        path: "{{ _mgr_runtime }}/manager_localhost.survive"
        state: touch
        mode: "0644"
