---
- name: "Converge \u2014 switch_access_policies (overridden)"
  hosts: localhost
  gather_facts: false
  vars_files:
  - vars.yml
  tasks:
  - name: Gather current switch_access_policies to get server-assigned IDs
    cisco.meraki_rm.meraki_switch_access_policies:
      network_id: N_123456789012345678
      state: gathered
    register: current

  - name: Build config with actual server-assigned PK
    ansible.builtin.set_fact:
      overridden_config: >-
        {{ expected_config | combine({'access_policy_number': current.gathered[0].access_policy_number}) }}
    when: current.gathered | length > 0

  - name: Overridden switch_access_policies configuration
    cisco.meraki_rm.meraki_switch_access_policies:
      network_id: N_123456789012345678
      state: overridden
      config:
      - "{{ overridden_config }}"
    register: overridden_result
    when: overridden_config is defined
